<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Geospatial Visualization – Massachusetts</title>
<script src="https://d3js.org/d3.v7.min.js"></script>
<script src="https://unpkg.com/topojson-client@3"></script>
<style>
  body {
    font-family: 'Segoe UI', sans-serif;
    display: flex;
    flex-direction: column;
    align-items: center;
    background: #fafafa;
    margin: 0;
    padding: 20px;
  }
  h1 { text-align: center; margin-bottom: 0; }
  h3 { text-align: center; margin-top: 5px; color: #555; }

  .map-container {
    display: flex;
    flex-direction: column;
    align-items: center;
    margin: 20px 0;
  }
  svg {
    width: 700px;
    height: 450px;
    border: 1px solid #ccc;
    margin: 10px 0;
  }
  .tooltip {
    position: absolute;
    background: white;
    border: 1px solid #ccc;
    padding: 8px;
    font-size: 13px;
    border-radius: 6px;
    pointer-events: none;
    display: none;
    box-shadow: 0 2px 8px rgba(0,0,0,0.2);
  }
</style>
</head>
<body>

<h1>Geospatial Visualizations – Massachusetts</h1>
<h3>Your Name</h3>

<div class="map-container">
  <h2>Map A – Simulated Population in 1980</h2>
  <svg id="mapA"></svg>

  <h2>Map B – Simulated Population Change (1980–2010)</h2>
  <svg id="mapB"></svg>

  <h2>Map C – Gini Index by County (2019)</h2>
  <svg id="mapC"></svg>
</div>

<div id="tooltip" class="tooltip"></div>

<script>
const width = 700, height = 450;
const tooltip = d3.select("#tooltip");

Promise.all([
  d3.json("data/towns.topojson"),
  d3.csv("data/gini_index.csv")
]).then(([topology, giniData]) => {

  const geojson = topojson.feature(topology, Object.values(topology.objects)[0]);

  // Simulated population data (since we don't have a population CSV)
  const popData = giniData.map(d => ({
    name: d["Geographic Area Name"],
    pop1980: Math.random() * 50000 + 10000, // fake population 10k–60k
    pop2010: Math.random() * 80000 + 20000  // fake population 20k–100k
  }));
  const popMap = new Map(popData.map(d => [d.name, d]));
  const giniMap = new Map(giniData.map(d => [d["Geographic Area Name"], +d["Estimate!!Gini Index"]]));

  const projection = d3.geoMercator().fitSize([width, height], geojson);
  const path = d3.geoPath().projection(projection);

  // ---------- MAP A ----------
  const svgA = d3.select("#mapA");
  const colorA = d3.scaleSequential(d3.interpolateBlues)
                   .domain(d3.extent(popData, d => d.pop1980));

  svgA.selectAll("path")
    .data(geojson.features)
    .join("path")
    .attr("d", path)
    .attr("fill", d => {
      const p = popMap.get(d.properties.TOWN || d.properties.TOWN_NAME || d.properties.NAME);
      return p ? colorA(p.pop1980) : "#ccc";
    })
    .attr("stroke", "#333")
    .on("mouseenter", (event, d) => {
      d3.select(event.currentTarget).attr("stroke-width", 2).attr("stroke", "black");
      const p = popMap.get(d.properties.TOWN || d.properties.TOWN_NAME || d.properties.NAME);
      tooltip.style("display", "block")
             .html(`<strong>${d.properties.TOWN || d.properties.TOWN_NAME}</strong><br>
                    Population (1980): ${p ? Math.round(p.pop1980) : "N/A"}`);
    })
    .on("mousemove", event => tooltip.style("left", (event.pageX + 10) + "px")
                                     .style("top", (event.pageY - 28) + "px"))
    .on("mouseleave", event => {
      tooltip.style("display", "none");
      d3.select(event.currentTarget).attr("stroke-width", 1).attr("stroke", "#333");
    });

  // ---------- MAP B ----------
  const svgB = d3.select("#mapB");
  const colorB = d3.scaleDiverging(d3.interpolateRdYlGn)
                   .domain([-50000, 0, 50000]);

  svgB.selectAll("path")
    .data(geojson.features)
    .join("path")
    .attr("d", path)
    .attr("fill", d => {
      const p = popMap.get(d.properties.TOWN || d.properties.TOWN_NAME || d.properties.NAME);
      return p ? colorB(p.pop2010 - p.pop1980) : "#ccc";
    })
    .attr("stroke", "#333")
    .on("mouseenter", (event, d) => {
      d3.select(event.currentTarget).attr("stroke-width", 2).attr("stroke", "black");
      const p = popMap.get(d.properties.TOWN || d.properties.TOWN_NAME || d.properties.NAME);
      tooltip.style("display", "block")
             .html(`<strong>${d.properties.TOWN || d.properties.TOWN_NAME}</strong><br>
                    Change (1980–2010): ${p ? Math.round(p.pop2010 - p.pop1980) : "N/A"}`);
    })
    .on("mousemove", event => tooltip.style("left", (event.pageX + 10) + "px")
                                     .style("top", (event.pageY - 28) + "px"))
    .on("mouseleave", event => {
      tooltip.style("display", "none");
      d3.select(event.currentTarget).attr("stroke-width", 1).attr("stroke", "#333");
    });

  // ---------- MAP C (GINI INDEX with temporal line chart) ----------
  const svgC = d3.select("#mapC");
  const colorC = d3.scaleSequential(d3.interpolateOrRd)
                   .domain(d3.extent(giniData, d => +d["Estimate!!Gini Index"]));
  const giniByTown = d3.group(giniData, d => d["Geographic Area Name"]);

  svgC.selectAll("path")
    .data(geojson.features)
    .join("path")
    .attr("d", path)
    .attr("fill", d => {
      const g = giniMap.get(d.properties.TOWN || d.properties.TOWN_NAME || d.properties.NAME);
      return g ? colorC(g) : "#ccc";
    })
    .attr("stroke", "#333")
    .on("mouseenter", (event, d) => {
      const townName = d.properties.TOWN || d.properties.TOWN_NAME || d.properties.NAME;
      const data = giniByTown.get(townName) || [];

      tooltip.style("display", "block")
             .style("left", (event.pageX + 10) + "px")
             .style("top", (event.pageY - 150) + "px")
             .html(`<strong>${townName}</strong><br>Gini Index over Years<br><svg id="tooltipChart" width="200" height="100"></svg>`);

      // Draw small line chart in tooltip
      const margin = {top: 10, right: 10, bottom: 20, left: 30};
      const w = 200 - margin.left - margin.right;
      const h = 100 - margin.top - margin.bottom;

      const svgTip = d3.select("#tooltipChart")
                       .append("g")
                       .attr("transform", `translate(${margin.left},${margin.top})`);

      const x = d3.scaleLinear()
                  .domain(d3.extent(data, d => +d.year))
                  .range([0, w]);
      const y = d3.scaleLinear()
                  .domain([0, d3.max(data, d => +d["Estimate!!Gini Index"])])
                  .range([h, 0]);

      const lineGen = d3.line()
                        .x(d => x(+d.year))
                        .y(d => y(+d["Estimate!!Gini Index"]));

      svgTip.append("g")
            .attr("transform", `translate(0,${h})`)
            .call(d3.axisBottom(x).ticks(data.length).tickFormat(d3.format("d")))
            .selectAll("text")
            .style("font-size", "8px");

      svgTip.append("g")
            .call(d3.axisLeft(y).ticks(3))
            .selectAll("text")
            .style("font-size", "8px");

      svgTip.append("path")
            .datum(data)
            .attr("fill", "none")
            .attr("stroke", "#d62728")
            .attr("stroke-width", 2)
            .attr("d", lineGen);
    })
    .on("mousemove", event => {
      tooltip.style("left", (event.pageX + 10) + "px")
             .style("top", (event.pageY - 150) + "px");
    })
    .on("mouseleave", () => {
      tooltip.style("display", "none")
             .selectAll("*").remove();
    });

});
</script>

</body>
</html>
